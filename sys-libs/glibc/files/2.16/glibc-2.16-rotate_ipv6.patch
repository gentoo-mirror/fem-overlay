From: Marcel Pennewiﬂ <gentoo@pennewiss.de>
Date: Wed, 27 Nov 2013 21:51:18 +0200
Subject: [PATCH] Fix handling of nameserver addresses

Patch based on
https://bugzilla.redhat.com/show_bug.cgi?id=841787

--- resolv/res_send.c
+++ resolv/res_send.c
@@ -421,10 +421,10 @@
 				EXT(statp).nsmap[n] = MAXNS;
 			}
 		}
-		n = statp->nscount;
-		if (statp->nscount > EXT(statp).nscount)
+		n = statp->nscount - EXT(statp).nscount6;
+		if (n > EXT(statp).nscount)
 			for (n = EXT(statp).nscount, ns = 0;
-			     n < statp->nscount; n++) {
+				n < statp->nscount - EXT(statp).nscount6; n++) {
 				while (ns < MAXNS
 				       && EXT(statp).nsmap[ns] != MAXNS)
 					ns++;
@@ -441,7 +441,7 @@
 				    malloc(sizeof (struct sockaddr_in6));
 			if (EXT(statp).nsaddrs[n] != NULL) {
 				memset (mempcpy(EXT(statp).nsaddrs[n],
-						&statp->nsaddr_list[n],
+						&statp->nsaddr_list[ns],
 						sizeof (struct sockaddr_in)),
 					'\0',
 					sizeof (struct sockaddr_in6)
--- resolv/res_init.c
+++ resolv/res_init.c
@@ -307,9 +307,9 @@
 			cp++;
 		    if ((*cp != '\0') && (*cp != '\n')
 			&& __inet_aton(cp, &a)) {
-			statp->nsaddr_list[nservall].sin_addr = a;
-			statp->nsaddr_list[nservall].sin_family = AF_INET;
-			statp->nsaddr_list[nservall].sin_port =
+			statp->nsaddr_list[nserv].sin_addr = a;
+			statp->nsaddr_list[nserv].sin_family = AF_INET;
+			statp->nsaddr_list[nserv].sin_port =
 				htons(NAMESERVER_PORT);
 			nserv++;
 #ifdef _LIBC
